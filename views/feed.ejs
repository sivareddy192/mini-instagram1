<!DOCTYPE html>
<html>
<head>
  <title>Mini Instagram</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100">

  <!-- Flash Auto Hide -->
  <script>
    setTimeout(() => {
      const success = document.getElementById("flash-success");
      const error = document.getElementById("flash-error");

      if (success) {
        success.style.opacity = "0";
        setTimeout(() => success.remove(), 500);
      }

      if (error) {
        error.style.opacity = "0";
        setTimeout(() => error.remove(), 500);
      }
    }, 3000);
  </script>

  <!-- Navbar -->
  <div class="bg-white shadow p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold text-pink-500">Mini Instagram</h1>
    <a href="/logout" class="bg-red-500 text-white px-4 py-1 rounded">
      Logout
    </a>
  </div>

  <!-- Flash Messages -->
  <div class="max-w-xl mx-auto mt-4 px-4">

    <% if (success_msg && success_msg.length > 0) { %>
      <div id="flash-success"
           class="bg-green-500 text-white p-3 rounded mb-3 shadow transition-opacity duration-500">
        <%= success_msg %>
      </div>
    <% } %>

    <% if (error_msg && error_msg.length > 0) { %>
      <div id="flash-error"
           class="bg-red-500 text-white p-3 rounded mb-3 shadow transition-opacity duration-500">
        <%= error_msg %>
      </div>
    <% } %>

  </div>

  <!-- Create Post -->
  <div class="max-w-xl mx-auto mt-6 bg-white p-4 rounded-xl shadow">
    <h2 class="font-semibold mb-3">Create Post</h2>

    <form action="/create" method="POST" enctype="multipart/form-data" class="space-y-3">
      <input type="file"
             name="images"
             multiple
             accept="image/*"
             class="w-full border p-2 rounded"
             required />

      <input type="text"
             name="caption"
             placeholder="Write a caption..."
             class="w-full border p-2 rounded"
             required />

      <button class="w-full bg-pink-500 text-white py-2 rounded hover:bg-pink-600">
        Post
      </button>
    </form>
  </div>

  <!-- Posts -->
  <div class="max-w-6xl mx-auto mt-6 px-4">
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6">

      <% posts.forEach((post, index) => { %>
        <div class="bg-white rounded-xl shadow overflow-hidden hover:shadow-lg transition">

          <!-- Username -->
          <div class="p-4 font-semibold border-b">
            <%= post.user.username %>
          </div>

          <!-- Images -->
          <div class="p-2">

            <% if (post.images && post.images.length > 0) { %>

              <!-- Slider Container -->
              <div class="relative w-full overflow-hidden">

                <div class="flex transition-transform duration-300 w-full"
                     id="slider-<%= index %>">

                  <% post.images.forEach(img => { %>
                    <img src="<%= img %>"
                         class="w-full h-64 object-cover flex-shrink-0" />
                  <% }) %>

                </div>

              </div>

              <!-- Dots -->
              <div class="flex justify-center mt-2 space-x-2">
                <% post.images.forEach((img, dotIndex) => { %>
                  <button
                    class="w-2 h-2 rounded-full bg-gray-400"
                    onclick="moveSlide(<%= index %>, <%= dotIndex %>)"
                    id="dot-<%= index %>-<%= dotIndex %>">
                  </button>
                <% }) %>
              </div>

            <% } else if (post.image) { %>

              <!-- Old Single Image -->
              <img src="<%= post.image %>"
                   class="w-full h-64 object-cover rounded-lg" />

            <% } else { %>

              <!-- No Image -->
              <div class="w-full h-64 flex items-center justify-center bg-gray-100 text-gray-400">
                No Image
              </div>

            <% } %>

          </div>

          <!-- Caption + Actions -->
          <div class="p-4">
            <p class="mb-3 text-gray-700"><%= post.caption %></p>

            <% if (post.user._id.toString() === userId) { %>
              <div class="flex gap-3">
                <a href="/edit/<%= post._id %>"
                   class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition">
                  Edit
                </a>

                <a href="/delete/<%= post._id %>"
                   class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition">
                  Delete
                </a>
              </div>
            <% } %>

          </div>

        </div>
      <% }) %>

    </div>
  </div>

  <!-- Pagination -->
  <div class="max-w-xl mx-auto mt-8 flex justify-center items-center gap-4">

    <% if (currentPage > 1) { %>
      <a href="/feed?page=<%= currentPage - 1 %>"
         class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
        Previous
      </a>
    <% } %>

    <span class="font-semibold">
      Page <%= currentPage %> of <%= totalPages %>
    </span>

    <% if (currentPage < totalPages) { %>
      <a href="/feed?page=<%= currentPage + 1 %>"
         class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
        Next
      </a>
    <% } %>

  </div>

  <!-- SAFE SLIDER SCRIPT -->
  <script>
    function moveSlide(postIndex, slideIndex) {
      const slider = document.getElementById(`slider-${postIndex}`);
      if (!slider) return;

      const totalSlides = slider.children.length;

      slider.style.transform = `translateX(-${slideIndex * 100}%)`;

      for (let i = 0; i < totalSlides; i++) {
        const dot = document.getElementById(`dot-${postIndex}-${i}`);
        if (dot) {
          dot.classList.remove("bg-black");
          dot.classList.add("bg-gray-400");
        }
      }

      const activeDot = document.getElementById(`dot-${postIndex}-${slideIndex}`);
      if (activeDot) {
        activeDot.classList.remove("bg-gray-400");
        activeDot.classList.add("bg-black");
      }
    }

    // Activate first dot automatically
    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll('[id^="dot-"][id$="-0"]').forEach(dot => {
        dot.classList.remove("bg-gray-400");
        dot.classList.add("bg-black");
      });
    });
  </script>

</body>
</html>